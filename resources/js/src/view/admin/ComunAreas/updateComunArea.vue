<script setup>
import { onMounted, ref, watch} from 'vue';
import { Notify } from 'quasar'
import { useRoute, useRouter } from 'vue-router';
import { useComunAreaStore } from '@/services/store/comunArea.store';

  const comunAreaStore = useComunAreaStore()
  const router = useRouter()
  const route = useRoute()
  const comunArea = ref({})
  const loading = ref(false)
  const step = ref(0)
  const ready = ref(false)


  const backButton = () => {
    step.value--
  } 
  const nextStep = () => {
    if(step.value == 1) {
      updateComunArea()
      return
    }

    step.value++
  }
  const updateComunArea = () => {
    loading.value = true 
    comunArea.value.warrantyPrice =  comunArea.value.warranty_price
    comunArea.value.maxTime =  comunArea.value.max_time_reserve

    comunAreaStore.updateComunArea(comunArea.value)
    .then((response) => {
      if(response.code !==200) throw response 
      showNotify('positive', 'Area común actualizada con exito')
      setTimeout(()=>{
        loading.value = false
        router.go(-1)

      },1000)
    })
    .catch((response) =>{
      loading.value = false
      showNotify('negative', response)
    })
  }

  const showNotify = (type,text) => {
    Notify.create({
      color:type,
      message: text,
      timeout:2000
    })
  }

  const getComunAreaById = () => {
    comunAreaStore.getComunAreaById(route.params.id)
    .then((response) => {
      comunArea.value = response.data
      setTimeout(() => {
        ready.value = true
      }, 500);
    })
  }


  onMounted(() => {
    getComunAreaById()
  })
  
</script>
<template>
<div class="md:px-20 md:mx-16 px-2 h-full" style="overflow: hidden; ">
  <div class="text-center text-black text-h5 text-bold md:mt-4 mt-8 md:mb-8 mb-4">
    Datos del area común
  </div>
  <q-form
    @submit="nextStep()"
    class="h-full"
  >

    <div class=" w-full h-full" v-if="ready" >
      <Transition name="horizontal">

        <div class="row w-full" v-if="step==0">
  
          <div class="col-md-6 col-12 mt-1 px-2 md:px-12">
            <div class="text-subtitle2 text-black">
              Nombre del area
            </div>
            <q-input
                dense
                borderless
                clearable
                v-model="comunArea.name"
                class="form__inputsR mt-1"
                color="primary"
                :rules="[ val => val && val.length > 0 || 'Nombre de area es requerido']"
              />
          </div>
          <div class="col-md-6 col-12 mt-1 px-2 md:px-12">
            <div class="text-subtitle2 text-black">
              Aforo
            </div>
            <q-input
                dense
                borderless
                clearable
                v-model="comunArea.capacity"
                class="form__inputsR mt-1"
                color="primary"
                :rules="[ val => !(!val) || 'El aforo es requerido']"
              />
          </div>
          <div class="col-md-6 col-12 mt-1 px-2 md:px-12">
            <div class="text-subtitle2 text-black">
              Precio por reserva
            </div>
            <q-input
                dense
                borderless
                clearable
                v-model="comunArea.price"
                class="form__inputsR mt-1"
                color="primary"
                hint="Dejar en 0 si no requiere reserva"
              />
          </div>
          <div class="col-md-6 col-12 mt-2 px-2 md:px-12">
            <div class="text-subtitle2 text-black">
              Precio de garantia
            </div>
            <q-input
                dense
                borderless
                clearable
                v-model="comunArea.warranty_price"
                class="form__inputsR mt-1"
                color="primary"
                hint="Dejar en 0 si no aplica garantia"
                
              />
          </div>
    
          <div class="col-md-6 col-12 mt-2 px-2 md:px-12">
            <div class="text-subtitle2 text-black">
              Descripción
            </div>
            <q-input
              borderless
              clearable
              v-model="comunArea.description"
              class="form__inputsR mt-1"
              color="primary"
            />
          </div>
        </div>
      </Transition>

      <Transition name="horizontal">
        <div class="row w-full" v-if="step==1">
  
          <div class="col-md-6 col-12  row mt-1 px-2 md:px-12">
            <div class="col-12">
              <div class="text-subtitle2 text-black ">
                Maximo de horas de reserva
              </div>
              <q-input
                  dense
                  borderless
                  clearable
                  v-model="comunArea.max_time_reserve"
                  class="form__inputsR mt-1"
                  autofocus
                  color="primary"
                  :rules="[ val => !(!val) ||  'Las horas maxima de reserva es necesaria']"
              />
            </div>
            <div class="col-12 mt-6">
              <div class="text-subtitle2 text-black">
                Horas disponibles:
              </div>
              <div class="row w-full mt-4">
                <div class="col-6  pr-2 md:pr-4">
                  <div class="text-body2 text-black" style="font-weight: medium;">
                    Desde:
                  </div>
                  <q-input v-model="comunArea.timeFrom" mask="time" dense
                    borderless
                    clearable
                    class="form__inputsR mt-1"
                    color="primary"
                  >
                    <template v-slot:append>
                      <q-icon name="eva-clock-outline" class="cursor-pointer">
                        <q-popup-proxy cover transition-show="scale" transition-hide="scale">
                          <q-time v-model="comunArea.timeFrom">
                            <div class="row items-center justify-end">
                              <q-btn v-close-popup label="Aceptar" color="primary" flat />
                            </div>
                          </q-time>
                        </q-popup-proxy>
                      </q-icon>
                    </template>
                  </q-input>

                </div>
                <div class="col-6  pl-2 md:pl-4">
                  <div class="text-body2 text-black" style="font-weight: medium;">
                    Hasta:
                  </div>
                  <q-input v-model="comunArea.timeTo" mask="time" dense
                    borderless
                    clearable
                    class="form__inputsR mt-1"
                    color="primary"
                  >
                    <template v-slot:append>
                      <q-icon name="eva-clock-outline" class="cursor-pointer">
                        <q-popup-proxy cover transition-show="scale" transition-hide="scale">
                          <q-time v-model="comunArea.timeTo">
                            <div class="row items-center justify-end">
                              <q-btn v-close-popup label="Aceptar" color="primary" flat />
                            </div>
                          </q-time>
                        </q-popup-proxy>
                      </q-icon>
                    </template>
                  </q-input>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-12 mt-1 px-2 md:px-12">
            <div class="text-subtitle2 text-black">
              Normas
            </div>
            <q-input
                dense
                borderless
                clearable
                type="textarea"
                v-model="comunArea.rules"
                class="form__inputsR mt-1"
                color="primary"
                :rules="[ val => val && val.length > 0 || 'Indica las reglas']"
              />
          </div>
          
        </div>
      </Transition>

      <div class="w-full mb-2 px-2 md:px-12 flex justify-center mt-10">
        <q-btn color="grey-7" style="border-radius: 0.5rem;" @click="backButton()" v-if="step == 1" class="me-7"> 
          <div class="md:px-10 px-5 py-1" >
            Volver
          </div>
        </q-btn>
        <q-btn color="primary " style="border-radius: 0.5rem;" type="submit" :loading="loading">
          <div class="md:px-10 px-10 py-1" >
            Siguiente
          </div>
        </q-btn>
      </div>
    </div>
    <div class="h-4/6 flex flex-center" v-else> 
      <q-spinner
        color="primary"
        size="10rem"
        :thickness="5"
      />
    </div>

  </q-form>
</div>
</template>
<style lang="scss">
.form__inputsR{
  & .q-field__inner {
    box-shadow: 0px 3px 4px 0px #bfbfbf48;
    border-radius: 0.5rem;
    border: 1px solid rgb(223, 223, 223);
    padding: 0px 1rem;
  }
}
@media (max-width: 780px) {
.form__inputsR{
  & .q-field__inner {

    padding: 0.1rem 1rem;
  }
}
}

</style>